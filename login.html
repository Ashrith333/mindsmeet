<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Minds Meet - Login or Sign Up</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&amp;family=Pacifico&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<!-- Firebase SDK - Modern Modular SDK -->
<script type="module">
  // Import Firebase functions
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBkEbvGk_kxL3d1IB2zgYFpbixUBJ8EV8c",
    authDomain: "mindsmeet-a8945.firebaseapp.com",
    projectId: "mindsmeet-a8945",
    storageBucket: "mindsmeet-a8945.firebasestorage.app",
    messagingSenderId: "273248409523",
    appId: "1:273248409523:web:88fc2d8eefacc665c8ddc6",
    measurementId: "G-H8QD41XT3P"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  
  // Make auth available globally
  window.firebaseAuth = auth;
  
  // Function to check if email exists using createAuthUri
  async function checkEmailExists(email) {
    const apiKey = 'AIzaSyBkEbvGk_kxL3d1IB2zgYFpbixUBJ8EV8c';
    const url = `https://identitytoolkit.googleapis.com/v1/accounts:createAuthUri?key=${apiKey}`;

    const payload = {
      identifier: email,
      continueUri: "http://localhost"
    };

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      return data.registered === true;
    } catch (error) {
      return false;
    }
  }
  
  // Make function available globally
  window.checkEmailExists = checkEmailExists;
</script>
<style type="text/tailwindcss">
    :root {
      --primary-accent: #0284c7;--secondary-accent: #0ea5e9;--background-start: #7dd3fc;--background-end: #60a5fa;--text-primary: #1f2937;--text-secondary: #4b5563;--input-bg: #f0f9ff;--input-border: #bae6fd;--button-text: #ffffff;
      --white: #FFFFFF;
    }
    body {
      font-family: "Plus Jakarta Sans", sans-serif;
      background-color: var(--background-start);}
    .app-name {
      font-family: 'Pacifico', cursive;
    }
    input[type="text"] {
      background-color: var(--input-bg);
      border-color: var(--input-border);
      color: var(--text-primary);
    }
    input[type="text"]::placeholder {
      color: var(--text-secondary);
    }
    .input-focus:focus {
      box-shadow: 0 0 0 2px var(--white), 0 0 0 4px var(--primary-accent);
      border-color: var(--primary-accent);
    }
  </style>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-[var(--background-start)] to-[var(--background-end)] p-4">
<div class="w-full max-w-xs space-y-8">
<div class="text-center">
<h1 class="text-5xl font-bold app-name text-white">Minds Meet</h1>
</div>
<form class="space-y-6" id="login-form">
<div>
<label class="sr-only" for="identifier">
        Phone or Email
      </label>
<input class="w-full px-4 py-3.5 border rounded-lg focus:ring-2 focus:ring-[var(--primary-accent)] focus:border-[var(--primary-accent)] input-focus transition-shadow duration-200 text-lg" id="identifier" name="identifier" placeholder="Phone or Email" type="text" required/>
</div>
<button class="w-full py-3.5 text-lg font-semibold text-[var(--button-text)] rounded-lg shadow-md bg-[var(--primary-accent)] hover:bg-[var(--secondary-accent)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-accent)] focus:ring-opacity-50 transition-all duration-300 transform hover:scale-105 active:scale-95" type="submit">
      Continue
    </button>
</form>
<p class="text-xs text-center text-white/80">
    By continuing, you agree to our <a class="underline hover:text-white" href="#">Terms</a> and <a class="underline hover:text-white" href="#">Privacy</a>.
  </p>
</div>

<script>
// This is the main function that runs when you click "Continue"
async function handleFormSubmit(event) {
  // 1. Prevent the form from submitting normally
  event.preventDefault();
  console.log("‚úÖ Step 1: Form submission started.");
  console.log("üîç Event object:", event);

  // 2. Get the email from the input field
  const emailInput = document.getElementById('identifier');
  const email = emailInput.value.trim();
  console.log(`‚úÖ Step 2: Got email: ${email}`);

  // 3. Get the button to show loading status
  const submitButton = document.querySelector('button[type="submit"]');

  // 4. Validate the email
  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    alert('Please enter a valid email address.');
    console.error("‚ùå Error: Invalid email format.");
    resetButtonState(); // Reset button state on validation error
    return;
  }
  console.log("‚úÖ Step 3: Email format is valid.");

  // 5. Show loading state on the button
  submitButton.disabled = true;
  submitButton.innerHTML = 'Checking...';
  console.log("‚úÖ Step 4: UI changed to loading state.");

  // 6. Check if Firebase is available
  console.log("üîç Checking Firebase availability...");
  console.log("üîç window.firebaseAuth:", window.firebaseAuth);

  if (!window.firebaseAuth) {
    console.error("‚ùå CRITICAL: Firebase is not properly loaded!");
    alert("Firebase is not properly loaded. Please refresh the page and try again.");
    resetButtonState(); // Reset button state on Firebase error
    return;
  }

  // 7. Check network connectivity
  if (!navigator.onLine) {
    console.error("‚ùå CRITICAL: No internet connection!");
    alert("No internet connection. Please check your network and try again.");
    resetButtonState(); // Reset button state on network error
    return;
  }
  console.log("‚úÖ Step 5: Network connection is available.");

  try {
    // 8. Check if email exists using checkEmailExists
    console.log("‚úÖ Step 6: Checking if email exists...");
    console.log("üîç About to call: checkEmailExists(" + email + ")");
    
    // Check if email exists using the proper Firebase method
    const isRegistered = await window.checkEmailExists(email);
    console.log("‚úÖ Step 7: Firebase responded. User exists:", isRegistered);
    
    if (isRegistered) {
      // User exists - has at least one sign-in method
      console.log("‚úÖ Step 8: User exists. Redirecting to SIGN IN page.");
      window.location.href = `verify.html?email=${encodeURIComponent(email)}&scenario=password`;
    } else {
      // User doesn't exist - no sign-in methods found
      console.log("‚úÖ Step 8: User does not exist. Redirecting to SIGN UP page.");
      window.location.href = `verify.html?email=${encodeURIComponent(email)}&scenario=signup`;
    }
    
  } catch (error) {
    console.log("üîç Firebase error response:", error);
    console.log("üîç Error code:", error.code);
    console.log("üîç Error message:", error.message);
    console.log("üîç Full error object:", error);
    
    if (error.code === 'auth/invalid-email') {
      // Invalid email format
      console.error("‚ùå Error: Invalid email format.");
      alert('Please enter a valid email address.');
      resetButtonState(); // Reset button state on validation error
    } else if (error.code === 'auth/network-request-failed') {
      // Network error
      console.error("‚ùå Error: Network request failed.");
      alert('Network error. Please check your internet connection and try again.');
      resetButtonState(); // Reset button state on network error
    } else {
      // For any other error, assume email doesn't exist and go to signup
      console.log("‚úÖ Step 7: Error occurred, assuming email does not exist. Redirecting to SIGN UP page.");
      console.log("üîç Error details for debugging:", error);
      window.location.href = `verify.html?email=${encodeURIComponent(email)}&scenario=signup`;
    }
  }
}

// Global error handler to catch any unexpected issues
window.addEventListener('error', function(event) {
  console.error('üö® UNEXPECTED GLOBAL ERROR:', event.message, event.error);
  resetButtonState(); // Reset button state on any global error
});

// Handle page visibility changes (when user navigates back/forward)
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    console.log('üîÑ Page became visible - resetting button state');
    resetButtonState();
  }
});

// Handle beforeunload event (when user is about to leave the page)
window.addEventListener('beforeunload', function() {
  console.log('üîÑ User is leaving page - resetting button state');
  resetButtonState();
});

// Log to confirm the script file itself is loaded
console.log("üîë Login page script loaded and ready.");

// This is the modern, reliable way to run code after the HTML page is loaded.
document.addEventListener('DOMContentLoaded', () => {
  // Reset button state when page loads
  resetButtonState();
  
  // Find the form on the page
  const loginForm = document.getElementById('login-form');
  
  if (loginForm) {
    // Attach our function to the form's 'submit' event
    loginForm.addEventListener('submit', handleFormSubmit);
    console.log("‚úÖ Event listener attached to form submission.");
  } else {
    console.error("‚ùå CRITICAL: Could not find the login form on the page to attach event listener.");
  }
});

// Function to reset button state
function resetButtonState() {
  const submitButton = document.querySelector('button[type="submit"]');
  if (submitButton) {
    submitButton.disabled = false;
    submitButton.innerHTML = 'Continue';
    console.log("‚úÖ Button state reset to normal.");
  }
}

// Manual test function - you can run this in console
window.testEmail = async function(email) {
  console.log("üß™ MANUAL TEST: Checking email:", email);
  
  if (!window.firebaseAuth) {
    console.error("‚ùå Firebase not properly loaded!");
    return null;
  }
  
  try {
    const isRegistered = await window.checkEmailExists(email);
    console.log("üß™ RESULT:", isRegistered);
    console.log("üß™ Is valid:", isRegistered);
    
    if (isRegistered) {
      console.log("üß™ RESULT: Email exists - should go to PASSWORD page");
      return { exists: true, methods: true };
    } else {
      console.log("üß™ RESULT: Email does not exist - should go to SIGNUP page");
      return { exists: false, methods: false };
    }
  } catch (error) {
    console.log("üß™ ERROR:", error);
    console.log("üß™ Error code:", error.code);
    console.log("üß™ Error message:", error.message);
    console.log("üß™ RESULT: Error occurred, assuming email does not exist - should go to SIGNUP page");
    return { exists: false, methods: false };
  }
};

console.log("üí° To test manually, run: window.testEmail('your-email@example.com')");
</script>

</body></html> 