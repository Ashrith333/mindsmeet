<html><head>
<meta charset="utf-8"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B600%3B700%3B800" onload="this.rel='stylesheet'" rel="stylesheet"/>
<title>Minds Meet - Verification</title>
<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBkEbvGk_kxL3d1IB2zgYFpbixUBJ8EV8c",
    authDomain: "mindsmeet-a8945.firebaseapp.com",
    projectId: "mindsmeet-a8945",
    storageBucket: "mindsmeet-a8945.firebasestorage.app",
    messagingSenderId: "273248409523",
    appId: "1:273248409523:web:88fc2d8eefacc665c8ddc6",
    measurementId: "G-H8QD41XT3P"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  
  console.log('Firebase initialized successfully on verify page');
</script>
<style type="text/tailwindcss">
      :root {
        --primary-color: #3fa2ed;
        --text-primary: #111518;
        --text-secondary: #617889;
        --bg-input: #f0f3f4;
        --bg-button-disabled: #e0e0e0;
      }
      .bg-primary { background-color: var(--primary-color); }
      .text-primary { color: var(--text-primary); }
      .text-secondary { color: var(--text-secondary); }
      .bg-input { background-color: var(--bg-input); }
      .placeholder-secondary::placeholder { color: var(--text-secondary); }
      .border-primary { border-color: var(--primary-color); }
      .ring-primary { ring-color: var(--primary-color); }
      .bg-button-disabled { background-color: var(--bg-button-disabled); }
    </style>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
<div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden">
<header class="flex items-center justify-between p-4">
<button class="p-2" onclick="window.history.back()">
<svg class="text-primary" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<polyline points="15 18 9 12 15 6"></polyline>
</svg>
</button>
<h1 class="text-xl font-semibold text-primary">Minds Meet</h1>
<button class="p-2">
<div class="text-primary" data-icon="Question" data-size="24px" data-weight="regular">
<svg fill="currentColor" height="24px" viewBox="0 0 256 256" width="24px" xmlns="http://www.w3.org/2000/svg">
<path d="M140,180a12,12,0,1,1-12-12A12,12,0,0,1,140,180ZM128,72c-22.06,0-40,16.15-40,36v4a8,8,0,0,0,16,0v-4c0-11,10.77-20,24-20s24,9,24,20-10.77,20-24,20a8,8,0,0,0-8,8v8a8,8,0,0,0,16,0v-.72c18.24-3.35,32-17.9,32-35.28C168,88.15,150.06,72,128,72Zm104,56A104,104,0,1,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"></path>
</svg>
</div>
</button>
</header>
<main class="flex-grow flex flex-col px-6 pt-8 pb-6">
<!-- Password Login Section (Existing Users) -->
<div class="flex flex-col space-y-6" id="password-section">
<h2 class="text-primary text-2xl font-bold leading-tight tracking-tight text-center">Welcome Back!</h2>
<p class="text-secondary text-base text-center mb-6">
            Enter your password to continue.
          </p>
<div>
<label class="block text-primary text-sm font-medium mb-2" for="password">Password</label>
<div class="relative">
<input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-primary focus:outline-none focus:ring-2 focus:ring-primary border-2 border-transparent bg-input h-14 placeholder-secondary p-4 text-base font-normal leading-normal focus:border-primary" id="password" placeholder="Enter your password" type="password" value=""/>
<button class="password-toggle absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5" type="button">
<svg class="text-secondary hover:text-primary" fill="none" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg">
<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
<circle cx="12" cy="12" r="3"></circle>
</svg>
</button>
</div>
</div>
<a class="text-sm font-medium text-primary hover:underline text-right" href="#">Forgot password?</a>
<button class="flex min-w-[84px] w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-14 px-5 bg-primary text-white text-base font-semibold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity" onclick="handlePasswordLogin()">
<span class="truncate">Continue</span>
</button>
</div>

<!-- Signup Section (New Users) -->
<div class="hidden flex-col space-y-6" id="signup-section">
<h2 class="text-primary text-2xl font-bold leading-tight tracking-tight text-center">Create Your Account</h2>
<p class="text-secondary text-base text-center mb-6">
            Set up your password to get started.
          </p>
<div>
<label class="block text-primary text-sm font-medium mb-2" for="signup-password">Create Password</label>
<div class="relative">
<input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-primary focus:outline-none focus:ring-2 focus:ring-primary border-2 border-transparent bg-input h-14 placeholder-secondary p-4 text-base font-normal leading-normal focus:border-primary" id="signup-password" placeholder="Create a strong password" type="password" value=""/>
<button class="signup-password-toggle absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5" type="button">
<svg class="text-secondary hover:text-primary" fill="none" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg">
<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
<circle cx="12" cy="12" r="3"></circle>
</svg>
</button>
</div>
</div>
<div>
<label class="block text-primary text-sm font-medium mb-2" for="confirm-password">Confirm Password</label>
<div class="relative">
<input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-primary focus:outline-none focus:ring-2 focus:ring-primary border-2 border-transparent bg-input h-14 placeholder-secondary p-4 text-base font-normal leading-normal focus:border-primary" id="confirm-password" placeholder="Confirm your password" type="password" value=""/>
<button class="confirm-password-toggle absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5" type="button">
<svg class="text-secondary hover:text-primary" fill="none" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg">
<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
<circle cx="12" cy="12" r="3"></circle>
</svg>
</button>
</div>
</div>
<div class="text-xs text-secondary">
<p>Password must contain:</p>
<ul class="list-disc list-inside mt-1 space-y-1">
<li>At least 8 characters</li>
<li>One uppercase letter</li>
<li>One lowercase letter</li>
<li>One number</li>
</ul>
</div>
<button class="flex min-w-[84px] w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-14 px-5 bg-primary text-white text-base font-semibold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity" onclick="handleSignup()">
<span class="truncate">Create Account</span>
</button>
</div>
<!-- Email Verification Section -->
<div class="hidden flex-col space-y-6" id="otp-section">
<h2 class="text-primary text-2xl font-bold leading-tight tracking-tight text-center">Verify Your Email</h2>
<p class="text-secondary text-base text-center mb-6">
              We've sent a verification email to <span class="font-semibold text-primary" id="verification-email">your email</span>. Please check your inbox and click the verification link.
            </p>
<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
<div class="flex">
<div class="flex-shrink-0">
<svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
</svg>
</div>
<div class="ml-3">
<p class="text-sm text-yellow-800">
<strong>Check your spam folder</strong> if you don't see the email in your inbox.
</p>
</div>
</div>
</div>
<div class="flex justify-between items-center text-sm">
<p class="text-secondary">Didn't receive the email?</p>
<button class="font-medium text-primary hover:underline" onclick="resendVerificationEmail()">Resend Email</button>
</div>
<button class="flex min-w-[84px] w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-14 px-5 bg-primary text-white text-base font-semibold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity" onclick="checkEmailVerification()">
<span class="truncate">I've Verified My Email</span>
</button>
<div class="text-center">
<button class="text-sm text-secondary hover:text-primary underline" onclick="window.location.href='index.html'">Continue without verification (not recommended)</button>
</div>
</div>
</main>
<footer class="px-6 pb-8 pt-4">
<p class="text-secondary text-xs font-normal leading-normal text-center">
          By continuing, you agree to our <a class="font-medium text-primary hover:underline" href="#">Terms</a>. Learn how we collect, use and share your data in our <a class="font-medium text-primary hover:underline" href="#">Privacy Policy</a> and how we use cookies and similar technology in our <a class="font-medium text-primary hover:underline" href="#">Cookie Policy</a>.
        </p>
</footer>
</div>
<script>
// Global variables
let currentUser = null;
let userEmail = '';

// Function to get URL parameters
function getQueryParam(param) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(param);
}

// Initialize page
function initializePage() {
  const scenario = getQueryParam('scenario') || 'password';
  userEmail = getQueryParam('email');
  
  console.log('=== VERIFY PAGE INITIALIZATION ===');
  console.log('Full URL:', window.location.href);
  console.log('Raw email parameter:', getQueryParam('email'));
  console.log('Scenario parameter:', scenario);
  console.log('Final userEmail:', userEmail);
  console.log('Current page URL:', window.location.href);
  
  // Validate that email is present
  if (!userEmail || userEmail.trim() === '') {
    console.error('âŒ No email found in URL parameters!');
    alert('Error: No email address found. Please go back and enter your email.');
    window.location.href = 'login.html';
    return;
  }
  
  // Validate email format
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(userEmail)) {
    console.error('âŒ Invalid email format in URL:', userEmail);
    alert('Error: Invalid email format. Please go back and enter a valid email.');
    window.location.href = 'login.html';
    return;
  }
  
  console.log('âœ… Email validation passed:', userEmail);
  
  const passwordSection = document.getElementById('password-section');
  const signupSection = document.getElementById('signup-section');
  const otpSection = document.getElementById('otp-section');
  
  if (!passwordSection || !signupSection || !otpSection) {
    console.error('One or more sections not found!');
    return;
  }
  
  // Hide all sections first
  [passwordSection, signupSection, otpSection].forEach(section => {
    section.classList.add('hidden');
    section.classList.remove('flex');
  });
  
  // Show appropriate section based on scenario
  switch(scenario) {
    case 'password':
      console.log('âœ… Showing PASSWORD LOGIN section for existing user:', userEmail);
      passwordSection.classList.remove('hidden');
      passwordSection.classList.add('flex');
      break;
      
    case 'signup':
      console.log('âœ… Showing SIGNUP section for new user:', userEmail);
      signupSection.classList.remove('hidden');
      signupSection.classList.add('flex');
      break;
      
    case 'otp':
      console.log('âœ… Showing EMAIL VERIFICATION section for:', userEmail);
      console.log('ðŸ“§ Email verification section should be visible now');
      otpSection.classList.remove('hidden');
      otpSection.classList.add('flex');
      const emailElement = document.getElementById('verification-email');
      if (emailElement) {
        emailElement.textContent = userEmail;
        console.log('âœ… Email element updated with:', userEmail);
      } else {
        console.error('âŒ Email element not found!');
      }
      break;
      
    default:
      console.log('âš ï¸ Unknown scenario, defaulting to password for:', userEmail);
      console.log('âš ï¸ Scenario was:', scenario);
      passwordSection.classList.remove('hidden');
      passwordSection.classList.add('flex');
  }
  
  // Setup password visibility toggles
  setupPasswordToggles();
}

// Setup password visibility toggles
function setupPasswordToggles() {
  const toggles = [
    { button: '.password-toggle', input: '#password' },
    { button: '.signup-password-toggle', input: '#signup-password' },
    { button: '.confirm-password-toggle', input: '#confirm-password' }
  ];
  
  toggles.forEach(({ button, input }) => {
    const toggleButton = document.querySelector(button);
    const passwordInput = document.querySelector(input);
    
    if (toggleButton && passwordInput) {
      toggleButton.addEventListener('click', function () {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-secondary hover:text-primary"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
        const eyeOffIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-secondary hover:text-primary"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;
        this.innerHTML = type === 'password' ? eyeIcon : eyeOffIcon;
      });
    }
  });
}

// Handle password login for existing users
async function handlePasswordLogin() {
  const passwordInput = document.getElementById('password');
  const password = passwordInput.value.trim();
  
  console.log('=== PASSWORD LOGIN ATTEMPT ===');
  console.log('Using email from URL parameter:', userEmail);
  console.log('Password length:', password.length);
  
  // Validate email is still present
  if (!userEmail || userEmail.trim() === '') {
    console.error('âŒ No email available for login!');
    alert('Error: Email missing. Please go back and enter your email.');
    window.location.href = 'login.html';
    return;
  }
  
  if (!password) {
    alert('Please enter your password');
    return;
  }
  
  const button = event.target.closest('button');
  button.disabled = true;
  button.querySelector('span').textContent = 'Signing in...';
  
  try {
    console.log('ðŸ” Attempting Firebase login for email:', userEmail);
    const userCredential = await firebase.auth().signInWithEmailAndPassword(userEmail, password);
    currentUser = userCredential.user;
    
    console.log('âœ… Login successful for:', currentUser.email);
    console.log('Email verified status:', currentUser.emailVerified);
    
    // Double-check that we're working with the right user
    if (currentUser.email.toLowerCase() !== userEmail.toLowerCase()) {
      console.error('âŒ Email mismatch! Expected:', userEmail, 'Got:', currentUser.email);
      alert('Error: Email mismatch detected. Please try again.');
      await firebase.auth().signOut();
      window.location.href = 'login.html';
      return;
    }
    
    // Check if email is verified
    if (currentUser.emailVerified) {
      console.log('âœ… Email is verified - redirecting to main app');
      alert('Login successful! Welcome back!');
      window.location.href = 'index.html';
    } else {
      console.log('âš ï¸ Email not verified - redirecting to verification page');
      alert('Please verify your email before continuing. Check your inbox for the verification link.');
      // Redirect to email verification page with the SAME email
      window.location.href = `verify.html?email=${encodeURIComponent(userEmail)}&scenario=otp`;
    }
    
  } catch (error) {
    console.error('âŒ Login error for email:', userEmail, error);
    
    let errorMessage = 'Login failed. ';
    if (error.code === 'auth/wrong-password') {
      errorMessage += 'Incorrect password.';
    } else if (error.code === 'auth/user-not-found') {
      errorMessage += 'No account found with this email.';
    } else if (error.code === 'auth/too-many-requests') {
      errorMessage += 'Too many failed attempts. Please try again later.';
    } else {
      errorMessage += 'Please try again.';
    }
    
    alert(errorMessage);
    
    // Reset button
    button.disabled = false;
    button.querySelector('span').textContent = 'Continue';
  }
}

// Validate password strength
function validatePassword(password) {
  const minLength = 8;
  const hasUpperCase = /[A-Z]/.test(password);
  const hasLowerCase = /[a-z]/.test(password);
  const hasNumbers = /\d/.test(password);
  
  return {
    isValid: password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers,
    message: password.length < minLength ? 'Password must be at least 8 characters long' :
             !hasUpperCase ? 'Password must contain at least one uppercase letter' :
             !hasLowerCase ? 'Password must contain at least one lowercase letter' :
             !hasNumbers ? 'Password must contain at least one number' : ''
  };
}

// Handle signup for new users
async function handleSignup() {
  const passwordInput = document.getElementById('signup-password');
  const confirmPasswordInput = document.getElementById('confirm-password');
  const password = passwordInput.value.trim();
  const confirmPassword = confirmPasswordInput.value.trim();
  
  console.log('=== SIGNUP ATTEMPT ===');
  console.log('Using email from URL parameter:', userEmail);
  console.log('Password length:', password.length);
  
  // Validate email is still present
  if (!userEmail || userEmail.trim() === '') {
    console.error('âŒ No email available for signup!');
    alert('Error: Email missing. Please go back and enter your email.');
    window.location.href = 'login.html';
    return;
  }
  
  // Validate passwords
  if (!password || !confirmPassword) {
    alert('Please fill in both password fields');
    return;
  }
  
  if (password !== confirmPassword) {
    alert('Passwords do not match');
    return;
  }
  
  const passwordValidation = validatePassword(password);
  if (!passwordValidation.isValid) {
    alert(passwordValidation.message);
    return;
  }
  
  const button = event.target.closest('button');
  button.disabled = true;
  button.querySelector('span').textContent = 'Creating account...';
  
  try {
    console.log('ðŸ” Attempting to create Firebase account for email:', userEmail);
    const userCredential = await firebase.auth().createUserWithEmailAndPassword(userEmail, password);
    currentUser = userCredential.user;
    
    console.log('âœ… Account created successfully for:', currentUser.email);
    
    // Double-check that we created the account with the right email
    if (currentUser.email.toLowerCase() !== userEmail.toLowerCase()) {
      console.error('âŒ Email mismatch! Expected:', userEmail, 'Got:', currentUser.email);
      alert('Error: Email mismatch detected. Please try again.');
      await firebase.auth().signOut();
      window.location.href = 'login.html';
      return;
    }
    
    // Send email verification
    console.log('ðŸ“§ Sending verification email to:', currentUser.email);
    await currentUser.sendEmailVerification();
    
    console.log('âœ… Verification email sent to:', currentUser.email);
    console.log('ðŸ”„ Redirecting to email verification page...');
    console.log('ðŸ”„ URL will be:', `verify.html?email=${encodeURIComponent(userEmail)}&scenario=otp`);
    
    // Redirect to email verification page for new users
    window.location.href = `verify.html?email=${encodeURIComponent(userEmail)}&scenario=otp`;
    
  } catch (error) {
    console.error('âŒ Signup error for email:', userEmail, error);
    
    let errorMessage = 'Account creation failed. ';
    if (error.code === 'auth/email-already-in-use') {
      errorMessage += 'An account with this email already exists.';
    } else if (error.code === 'auth/weak-password') {
      errorMessage += 'Password is too weak.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage += 'Invalid email address.';
    } else {
      errorMessage += 'Please try again.';
    }
    
    alert(errorMessage);
    
    // Reset button
    button.disabled = false;
    button.querySelector('span').textContent = 'Create Account';
  }
}

// Resend verification email
async function resendVerificationEmail() {
  try {
    // Get current user from Firebase auth
    const user = firebase.auth().currentUser;
    
    if (!user) {
      alert('Please sign in first to resend verification email');
      return;
    }
    
    console.log('Resending verification email to:', user.email);
    await user.sendEmailVerification();
    alert('Verification email sent! Please check your inbox and spam folder.');
    
  } catch (error) {
    console.error('Error sending verification email:', error);
    alert('Failed to send verification email. Please try again.');
  }
}

// Check email verification status
async function checkEmailVerification() {
  const button = event.target.closest('button');
  button.disabled = true;
  button.querySelector('span').textContent = 'Checking...';
  
  try {
    const user = firebase.auth().currentUser;
    
    if (!user) {
      alert('Please sign in again to verify your email status.');
      window.location.href = 'login.html';
      return;
    }
    
    console.log('Checking verification status for:', user.email);
    console.log('Current verification status:', user.emailVerified);
    
    // Reload user data to get latest verification status
    await user.reload();
    
    console.log('Updated verification status:', user.emailVerified);
    
    if (user.emailVerified) {
      console.log('âœ… Email verified successfully!');
      alert('Email verified successfully! Welcome to Minds Meet!');
      
      // Check if user has completed profile setup
      // For now, redirect to profile setup for new users
      // In a real app, you'd check the user's profile completion status in Firestore
      window.location.href = `profile-setup.html?email=${encodeURIComponent(user.email)}`;
    } else {
      console.log('âš ï¸ Email still not verified');
      alert('Email not yet verified. Please check your inbox and click the verification link. Check your spam folder too.');
      
      // Reset button
      button.disabled = false;
      button.querySelector('span').textContent = "I've Verified My Email";
    }
  } catch (error) {
    console.error('Error checking verification:', error);
    alert('Error checking verification status. Please try again.');
    
    // Reset button
    button.disabled = false;
    button.querySelector('span').textContent = "I've Verified My Email";
  }
}

// Initialize page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  initializePage();
  
  // Listen for auth state changes
  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      console.log('User is signed in:', user.email);
      console.log('Email verified:', user.emailVerified);
      currentUser = user;
    } else {
      console.log('User is signed out');
      currentUser = null;
    }
  });
});
</script>

</body></html> 